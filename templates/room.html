{% extends 'base.html' %} {% block content %}
<div id="room-container">
  <h1 id="home-header">SecureChatApp ðŸ’¬</h1>

  <div id="room-subsection">
    <h2 id="room-code-display">Room Code: <span>{{room}}</span></h2>
    <a href="{{ url_for('logout') }}" id="leave-chat-btn">Leave the Chat</a>
  </div>
  <div id="chat-room-widget">
    <div id="msgs-container">
      <ul id="messages"></ul>
    </div>
    <div id="message-box">
      <input type="text" placeholder="Enter your message" id="message-input" name="message" />
      <button type="submit" id="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.1/jsrsasign-all-min.js"></script>

  <script type="text/javascript">


    var socketio = io();
    console.log('Socket.io initialized');

    function trimEmail(email) {
        return email.split('@')[0];
    }

    socketio.on("message", function (message) { 
      console.log('Message received:', message);
      const { message: msgContent, sender, signature, publicKey } = message;
      
      const isVerified = verifySignature(msgContent, signature, publicKey);
      
      createChatItem(msgContent, sender, isVerified)});
      
    
      function createChatItem(message, sender, isVerified) {
        console.log('Creating chat item with message:', message, 'and sender:', sender, 'Verified:', isVerified);
      var messages = document.getElementById("messages");
      if (sender === "") {
        content = `<p class="member-activity">${message}</p>`;
      } else {
        var senderIsUser = "{{user}}" === sender;
        var trimmedSender = trimEmail(sender);
        var verificationStatus = isVerified ? 'Verified' : 'Not Verified';
        var content = `

          <li class="message-item ${senderIsUser ? "self-message-item" : "peer-message-item"}">
                <span class="sender-name ${senderIsUser ? "self-sender" : "peer-sender"}">${senderIsUser ? "You" : trimmedSender}</span>
                <p class="message-content">${message}</p>
                <small class="${senderIsUser ? "muted-text" : "muted-text-white"}">${new Date().toLocaleString()}</small>
            </li>
      `;}
      messages.innerHTML += content;
    }

//code+
function fetchAndStoreKeys() {
  fetch('/get_keys')
  .then(response => {
    if (!response.ok) {
                throw new Error('Failed to fetch keys');
            }
            return response.json();
        })
        .then(data => {
          localStorage.setItem('privateKey', data.private_key);
            //localStorage.setItem('publicKey', data.public_key);
            console.log('Keys stored successfully');
        })
        .catch(error => {
            console.error('Error fetching or storing keys:', error);
        });
}

fetchAndStoreKeys();

//signmessage
function signMessage(message) {
  console.log('signMessage called with:', message);
  const { privateKey } = getKeys();
  if (!privateKey) {
    console.error('Private key not found');
        return '';
    }
    const sig = new KJUR.crypto.Signature({ "alg": "SHA256withRSA" });
    sig.init(privateKey);
    sig.updateString(message);
    const signature = sig.sign();
    console.log('Message signed, signature:', signature);
    return signature;
}

//code+ close


  






    function sendMessage() {
      console.log('sendMessage called');
      var msgInput = document.getElementById("message-input");
      if (msgInput.value === "") return;
      var msg = msgInput.value;
      const { privateKey, publicKey } = getKeys();
      
    }

    // Sign the message
    const signature = signMessage(msg);

    // Only emit if we successfully signed the message
    if (signature) {
      console.log('emit message called');
      socketio.emit("message", { 
        message: msg,
        signature: signature,
        publicKey: publicKey 
      });
      msgInput.value = "";
    } else {
      console.error('Failed to sign message');



  </script>
  {% for message in messages %}
  <script type="text/javascript">
    createChatItem("{{message.message}}", "{{message.sender}}");
  </script>
  {% endfor %}
</div>
{% endblock %}